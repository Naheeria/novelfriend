<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì†Œì„¤ ì°½ì‘ ë„ìš°ë¯¸</title>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
  :root{
    --bg:#f6f7f8;
    --card:#ffffff;
    --muted:#9aa0a6;
    --accent:#3b82f6;
    --danger:#ef4444;
    --line:#e5e7eb;
    --radius:12px;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "Pretendard", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg);
    color:#1f2937;
    -webkit-font-smoothing:antialiased;
  }

  header{
    position:sticky; top:0; z-index:60;
    background:var(--card);
    border-bottom:1px solid var(--line);
    padding:14px 18px;
    display:flex; align-items:center; gap:12px;
  }
  header h1{ margin:0; font-size:18px; font-weight:700; }

  /* layout */
  .wrap{
    max-width:1400px;
    margin:18px auto;
    padding:0 18px 60px;
    display:grid;
    grid-template-columns: 220px 1fr;
    gap:18px;
    align-items:start;
  }

  /* sidebar (tabs) */
  .sidebar{
    background:var(--card);
    border-radius:var(--radius);
    padding:12px;
    border:1px solid var(--line);
    height:fit-content;
  }
  .tabs{ display:flex; flex-direction:column; gap:8px; }
  .tab-btn{
    display:flex; align-items:center; gap:10px;
    padding:10px; border-radius:10px; border:none; cursor:pointer;
    background:transparent; color:var(--muted); font-weight:700; text-align:left; font-size:14px;
  }
  .tab-btn.active{ background:var(--accent); color:#fff; }

  /* main */
  .main { min-height:200px; }

  .section-card{
    background:var(--card);
    border-radius:var(--radius);
    padding:14px;
    border:1px solid var(--line);
    margin-bottom:16px;
  }

  h2{ margin:6px 0 12px; font-size:15px; font-weight:700; color:#111827; }

  /* Form Elements */
  input, textarea, select{
    width: 100%;
    padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#fff;
    font-size:14px; color:#111827;
    margin-top:4px; /* labelê³¼ì˜ ê°„ê²© */
    margin-bottom:12px; /* ë‹¤ìŒ ìš”ì†Œì™€ì˜ ê°„ê²© */
  }
  textarea{ resize:vertical; min-height:72px; }
  
  /* Select specific for Modal */
  .modal-content select:not([multiple]){
      padding: 10px 12px;
  }
  .modal-content select[multiple]{
    height: 150px; /* ë‹¤ì¤‘ ì„ íƒ ë°•ìŠ¤ ë†’ì´ ì§€ì • */
    margin-bottom: 8px;
    padding: 8px 10px;
  }

  .btn {
    background:var(--accent); color:#fff; border:none; padding:9px 12px; border-radius:10px; cursor:pointer; font-weight:700;
    transition: background-color 0.2s;
  }
  .btn:hover{ background:#2563eb; }
  .btn.ghost { 
    background:transparent; border:1px solid var(--line); color:var(--muted); font-weight:700; 
    transition: background-color 0.2s, opacity 0.2s;
  }
  .btn.ghost:hover{ background:#f3f4f6; }
  .btn.ghost:disabled { 
    opacity: 0.6; 
    cursor: not-allowed; 
    background: #f9fafb !important;
    border-color: #f3f4f6 !important;
    color: var(--muted) !important;
  }
  /* ë²„íŠ¼ì— danger ìŠ¤íƒ€ì¼ ì¶”ê°€ */
  .btn.danger {
    background: var(--danger);
    color: #fff;
  }
  .btn.danger:hover {
    background: #c30707; /* ì¡°ê¸ˆ ë” ì–´ë‘ìš´ ë¹¨ê°„ìƒ‰ */
  }


  /* '+' ë²„íŠ¼ì— ëŒ€í•œ ëª…ì‹œì ì¸ CSS ìŠ¤íƒ€ì¼ */
  .add-card-btn {
    width: 100%; 
    padding: 8px; 
    border: 1px dashed var(--line); 
    border-radius: 8px; 
    background: transparent; 
    color: var(--muted); 
    font-size: 14px; 
    font-weight: 700; 
    cursor: pointer; 
    margin-top: 4px; 
    transition: background-color 0.2s, color 0.2s, border-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
  }
  .add-card-btn:hover {
    background: var(--bg);
    color: var(--accent);
    border-color: var(--accent);
  }


  /* ======================================= */
  /* ìº¡ì²˜ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
  /* ======================================= */
  .capture-expand {
      width: fit-content !important; 
      max-width: none !important;
  }
  /* ìº¡ì²˜ ì‹œ ì»¬ëŸ¼ ë†’ì´ ì œí•œì„ í•´ì œí•˜ëŠ” í´ë˜ìŠ¤ (JSì—ì„œ ì¶”ê°€/ì œê±°) */
  .column.capture-full-height {
      max-height: none !important;
      height: fit-content !important;
      overflow: visible !important; /* ìŠ¤í¬ë¡¤ë°”ë„ ì—†ì•° */
  }


  /* ======================================= */
  /* 2. ìºë¦­í„° ì •ë¦¬ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
  /* ======================================= */
  #character-list{ 
    display:grid; 
    grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); 
    gap:12px; 
    margin-top:6px; 
  }

  .char-card{
    background:var(--card); border-radius:10px; padding:12px; border:1px solid var(--line);
    position:relative;
    min-height: 100px;
  }
  .char-card .char-name{ font-weight:700; margin-bottom:6px; }
  .char-card .char-desc{ font-size:13px; color:var(--muted); min-height:36px; white-space: pre-wrap;}

  .icon-btn{
    position:absolute; top:8px; right:8px; background:transparent; border:none; cursor:pointer; color:var(--muted);
    padding:6px; border-radius:6px;
  }
  .icon-btn.danger{ color:var(--danger); right:40px; }
  
  /* ======================================= */
  /* 3. í”Œë¡¯ ë³´ë“œ ìŠ¤íƒ€ì¼ */
  /* ======================================= */
  .board{
    display:flex; gap:12px; align-items:flex-start; padding:8px 2px; overflow:auto;
  }
  .column{
    background:var(--card);
    min-width:260px; 
    flex:0 0 280px; 
    border-radius:10px; padding:12px; border:1px solid var(--line);
    display:flex; flex-direction:column; 
    max-height:72vh; /* í‰ì†Œì—ëŠ” ë†’ì´ ì œí•œ ì ìš© */
  }
  .col-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; font-weight:800; font-size:14px; color:#111827; }
  .col-head .count{ font-size:13px; color:var(--muted); font-weight:600; }

  /* ì¹´ë“œê°€ ì—†ì„ ë•Œë„ ë“œë¡­ì¡´ ì—­í• ì„ í•  ìˆ˜ ìˆë„ë¡ ìµœì†Œ ë†’ì´ í™•ë³´ */
  .cards{ overflow:auto; padding-right:6px; min-height: 10px; } 
  .plot-card{
    background:#fff; border-radius:8px; padding:10px; margin-bottom:10px; border:1px solid var(--line);
    position:relative; cursor:grab;
  }
  .plot-card.dragging{ opacity:0.6; transform:scale(0.997); }
  .plot-card .title{ font-weight:700; margin-bottom:6px; font-size:14px; }
  .plot-card .content{ font-size:13px; color:var(--muted); margin-bottom:8px; white-space: pre-wrap;} 
  .plot-card .tags{ display:flex; gap:6px; flex-wrap:wrap; }
  .tag{ font-size:12px; padding:4px 8px; background:#eef2ff; border-radius:8px; color:#2a3a9d; }

  .plot-card .card-actions{ position:absolute; top:8px; right:8px; display:flex; gap:6px; }
  /* í”Œë¡¯ ì¹´ë“œ ë‚´ì˜ ì‚­ì œ ë²„íŠ¼ ì•„ì´ì½˜ ìœ„ì¹˜ ì¡°ì • */
  .plot-card .card-actions .icon-btn.delete-plot-btn {
      position: relative; /* ìƒëŒ€ì ì¸ ìœ„ì¹˜ë¡œ ë³€ê²½í•˜ì—¬ card-actions ì•ˆì— ë°°ì¹˜ */
      top: 0;
      right: 0;
      padding: 4px; /* í¬ê¸°ë¥¼ ì•½ê°„ ì¤„ì„ */
  }


  /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ìƒëµ) */
  .modal{
    display:none; 
    position:fixed; 
    inset:0; 
    background:rgba(2,6,23,0.5); 
    z-index:90; 
    align-items:center; 
    justify-content:center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .modal.open{ 
    display:flex; 
    opacity: 1; 
  }
  .modal-content{
    width:92%; 
    max-width:480px; 
    background:var(--card); 
    border-radius:var(--radius); 
    padding:24px; 
    border:1px solid var(--line);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); 
    transform: translateY(-20px);
    transition: transform 0.3s ease;
  }
  .modal.open .modal-content{
    transform: translateY(0);
  }
  .modal-head{ 
    display:flex; 
    align-items:center; 
    justify-content:space-between; 
    margin-bottom:18px; 
    font-size: 1.1em;
    font-weight: 700;
    color: #111827;
  }
  .close{ 
    background:transparent; 
    border:none; 
    font-size:24px; 
    cursor:pointer; 
    color:var(--muted);
    padding: 0;
    line-height: 1;
    transition: color 0.2s;
  }
  .close:hover { color: #555; }
  
  /* Label styling */
  label {
    display: block;
    font-weight: 600;
    font-size: 14px;
    color: #333;
    margin-bottom: 4px;
  }

  /* responsive */
  @media (max-width: 980px){
    .wrap{ grid-template-columns:1fr; }
    .board{ padding-bottom:18px; }
    .column{ min-width:86vw; flex:0 0 86vw; }
    /* ëª¨ë°”ì¼ì—ì„œ ìºë¦­í„° ì¹´ë“œ í¬ê¸° ì¡°ì • */
    #character-list{ grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); } 
    .sidebar{ order: -1; display:flex; }
    .tab-btn { font-size:13px; padding:8px; }
  }

  /* hide elements during capture */
  .no-print{ visibility:hidden !important; }
</style>
</head>
<body>
  <header>
    <h1>ì†Œì„¤ ì°½ì‘ ë„ìš°ë¯¸</h1>
  </header>

  <div class="wrap">
    <aside class="sidebar">
      <div class="tabs">
        <button class="tab-btn active" data-tab="character" onclick="openTab(event)">ğŸ‘¤ ìºë¦­í„° ì„¤ì •</button>
        <button class="tab-btn" data-tab="plot" onclick="openTab(event)">ğŸ“‹ í”Œë¡¯ ë³´ë“œ</button>
      </div>
    </aside>

    <main class="main">
      <section id="character" class="section-card">
        <h2>ìºë¦­í„°</h2>
        
        <div style="margin-bottom:12px;">
          <button class="btn" onclick="openCharacterModal()">+ ìºë¦­í„° ì¶”ê°€</button>
        </div>

        <div id="character-list"></div>
      </section>

      <section id="plot" class="section-card" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;">
          <h2 style="margin:0">í”Œë¡¯ ë³´ë“œ</h2>
          <div style="display:flex; gap:8px;">
            <button class="btn danger" onclick="resetPlotBoard()">í”Œë¡¯ ì´ˆê¸°í™”</button>
            <button class="btn" onclick="openPlotModal()">í”Œë¡¯ ì¶”ê°€</button>
            <button class="btn ghost" onclick="exportBoardAsPNG()">ë³´ë“œ ì „ì²´ PNG ì €ì¥</button>
          </div>
        </div>

        <div class="board" id="plot-board" aria-live="polite">
          <div class="column" data-stage="ê¸°" ondragover="allowDrop(event)" ondrop="onDrop(event, 'ê¸°')">
            <div class="col-head"><span>ê¸° (ë„ì…)</span><span class="count muted" data-count="0">0</span></div>
            <div class="cards"></div>
            <button class="add-card-btn" onclick="openPlotModal(null, 'ê¸°')">
              <span class="material-icons" style="font-size:18px">add</span> ì¹´ë“œ ì¶”ê°€
            </button>
          </div>

          <div class="column" data-stage="ìŠ¹" ondragover="allowDrop(event)" ondrop="onDrop(event, 'ìŠ¹')">
            <div class="col-head"><span>ìŠ¹ (ì „ê°œ)</span><span class="count muted" data-count="0">0</span></div>
            <div class="cards"></div>
            <button class="add-card-btn" onclick="openPlotModal(null, 'ìŠ¹')">
              <span class="material-icons" style="font-size:18px">add</span> ì¹´ë“œ ì¶”ê°€
            </button>
          </div>

          <div class="column" data-stage="ì „" ondragover="allowDrop(event)" ondrop="onDrop(event, 'ì „')">
            <div class="col-head"><span>ì „ (ìœ„ê¸°/ì ˆì •)</span><span class="count muted" data-count="0">0</span></div>
            <div class="cards"></div>
            <button class="add-card-btn" onclick="openPlotModal(null, 'ì „')">
              <span class="material-icons" style="font-size:18px">add</span> ì¹´ë“œ ì¶”ê°€
            </button>
          </div>

          <div class="column" data-stage="ê²°" ondragover="allowDrop(event)" ondrop="onDrop(event, 'ê²°')">
            <div class="col-head"><span>ê²° (ê²°ë§)</span><span class="count muted" data-count="0">0</span></div>
            <div class="cards"></div>
            <button class="add-card-btn" onclick="openPlotModal(null, 'ê²°')">
              <span class="material-icons" style="font-size:18px">add</span> ì¹´ë“œ ì¶”ê°€
            </button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="plotModal" class="modal" onclick="if(event.target===this) closePlotModal()">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-head">
        í”Œë¡¯ ì¹´ë“œ ì¶”ê°€ / ìˆ˜ì •
        <button class="close" onclick="closePlotModal()" title="ë‹«ê¸°">Ã—</button>
      </div>

      <label for="plot-title">ì œëª©</label>
      <input id="plot-title" placeholder="ì¥ë©´ ì œëª©">

      <label for="plot-stage">ë‹¨ê³„</label>
      <select id="plot-stage">
        <option>ê¸°</option><option>ìŠ¹</option><option>ì „</option><option>ê²°</option>
      </select>

      <label for="plot-chars">ê´€ë ¨ ìºë¦­í„° (ë‹¤ì¤‘ ì„ íƒ)</label>
      <select id="plot-chars" multiple size="6"></select>

      <label for="plot-content">ë‚´ìš©</label>
      <textarea id="plot-content" rows="5" placeholder="ì´ ì¥ë©´ì˜ ìš”ì•½/ì„¸ë¶€ ë¬˜ì‚¬"></textarea>

      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
        <button class="btn ghost" onclick="closePlotModal()">ì·¨ì†Œ</button>
        <button class="btn" onclick="savePlotCard()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <div id="charModal" class="modal" onclick="if(event.target===this) closeCharacterModal()">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-head">
        ìºë¦­í„° ì¶”ê°€ / ìˆ˜ì •
        <button class="close" onclick="closeCharacterModal()" title="ë‹«ê¸°">Ã—</button>
      </div>

      <label for="modal-char-name">ì´ë¦„</label>
      <input id="modal-char-name" placeholder="ìºë¦­í„° ì´ë¦„ (í•„ìˆ˜)">

      <label for="modal-char-desc">íŠ¹ì§• / í•œì¤„ ì„¤ëª…</label>
      <input id="modal-char-desc" placeholder="ì„±ê²©, ì—­í•  ë“±">

      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
        <button class="btn ghost" onclick="closeCharacterModal()">ì·¨ì†Œ</button>
        <button class="btn" onclick="saveCharacter()">ì €ì¥</button>
      </div>
    </div>
  </div>

<script>
/* Data */
let characterData = [];
let plotData = { 'ê¸°': [], 'ìŠ¹': [], 'ì „': [], 'ê²°': [] };
let editingPlotId = null;
let editingCharId = null;

/* Init */
window.addEventListener('load', () => {
  loadData();
  renderCharacterList();
  renderPlotBoard();
  populatePlotCharSelect();
  openTabByName('character');
});

/* Storage */
function saveAll(){
  localStorage.setItem('np_characterData', JSON.stringify(characterData));
  localStorage.setItem('np_plotData', JSON.stringify(plotData));
}
function loadData(){
  try {
    const c = localStorage.getItem('np_characterData');
    const p = localStorage.getItem('np_plotData');
    if(c) characterData = JSON.parse(c);
    if(p) plotData = JSON.parse(p);
  } catch(e){ console.error(e); }
}

/* Tabs */
function openTab(e){
  const btn = e.currentTarget;
  const tab = btn.dataset.tab;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  openTabByName(tab);
}
function openTabByName(tab){
  document.querySelectorAll('main .section-card').forEach(s=> s.style.display = 'none');
  const el = document.getElementById(tab);
  if(el) el.style.display = 'block';
}

/* Character */
function openCharacterModal(prefillName='', prefillDesc='', id=null){
  editingCharId = id;

  // ëª¨ë‹¬ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” ë˜ëŠ” ê¸°ì¡´ ë°ì´í„° ì±„ìš°ê¸°
  document.getElementById('modal-char-name').value = prefillName;
  document.getElementById('modal-char-desc').value = prefillDesc;

  document.getElementById('charModal').classList.add('open');
  document.getElementById('modal-char-name').focus(); 
}
function closeCharacterModal(){
  editingCharId = null;
  document.getElementById('modal-char-name').value = '';
  document.getElementById('modal-char-desc').value = '';
  document.getElementById('charModal').classList.remove('open');
}
function saveCharacter(){
  const name = document.getElementById('modal-char-name').value.trim();
  const desc = document.getElementById('modal-char-desc').value.trim();
  if(!name){ alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  if(editingCharId){
    const c = characterData.find(x=>x.id===editingCharId);
    if(c){ c.name = name; c.desc = desc; }
  } else {
    characterData.push({ id:Date.now().toString(), name, desc });
  }
  closeCharacterModal();
  renderCharacterList();
  populatePlotCharSelect();
  saveAll();
}
function renderCharacterList(){
  const wrap = document.getElementById('character-list');
  wrap.innerHTML = '';
  if(characterData.length===0){
    // white-space: nowrap; ì¶”ê°€í•˜ì—¬ ì¤„ ë°”ê¿ˆ ë°©ì§€
    wrap.innerHTML = `<div class="muted" style="padding: 10px 0; white-space: nowrap;">ì•„ì§ ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.</div>`;
    return;
  }
  characterData.forEach(c=>{
    const div = document.createElement('div');
    div.className = 'char-card';
    div.innerHTML = `
      <div class="char-name">${escapeHtml(c.name)}</div>
      <div class="char-desc">${escapeHtml(c.desc||'')}</div>
      <button class="icon-btn" title="í¸ì§‘" onclick="event.stopPropagation(); editCharacter('${c.id}')"><span class="material-icons" style="font-size:18px">edit</span></button>
      <button class="icon-btn danger" title="ì‚­ì œ" onclick="event.stopPropagation(); deleteCharacter('${c.id}')"><span class="material-icons" style="font-size:18px">delete</span></button>
    `;
    wrap.appendChild(div);
  });
}
function editCharacter(id){
  const c = characterData.find(x=>x.id===id);
  if(!c) return;
  openCharacterModal(c.name, c.desc, id);
}
function deleteCharacter(id){
  if(!confirm('ì •ë§ë¡œ ì´ ìºë¦­í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ í”Œë¡¯ì˜ ì—°ê²°ë„ ì œê±°ë©ë‹ˆë‹¤.')) return;
  characterData = characterData.filter(x=>x.id!==id);
  for(const s of Object.keys(plotData)){
    plotData[s].forEach(card => {
      if(card.charIds) card.charIds = card.charIds.filter(cid=>cid!==id);
    });
  }
  renderCharacterList();
  renderPlotBoard();
  populatePlotCharSelect();
  saveAll();
}

/* Plot modal */
function openPlotModal(id=null, stagePrefill='ê¸°'){
  editingPlotId = id;
  if(id){
    let found=null;
    for(const s of Object.keys(plotData)){
      const f = plotData[s].find(c=>c.id===id);
      if(f){ found=f; break; }
    }
    if(found){
      document.getElementById('plot-title').value = found.title;
      document.getElementById('plot-content').value = found.content;
      document.getElementById('plot-stage').value = found.stage || stagePrefill;
      populatePlotCharSelect(found.charIds || []);
    } else populatePlotCharSelect([]);
  } else {
    document.getElementById('plot-title').value = '';
    document.getElementById('plot-content').value = '';
    document.getElementById('plot-stage').value = stagePrefill;
    populatePlotCharSelect([]);
  }
  document.getElementById('plotModal').classList.add('open');
  document.getElementById('plot-title').focus(); 
}
function closePlotModal(){
  editingPlotId = null;
  document.getElementById('plot-title').value='';
  document.getElementById('plot-content').value='';
  document.getElementById('plotModal').classList.remove('open');
}
function populatePlotCharSelect(selectedIds=[]){
  const sel = document.getElementById('plot-chars');
  sel.innerHTML = '';
  characterData.forEach(c=>{
    const op = document.createElement('option');
    op.value = c.id;
    op.textContent = c.name;
    if(selectedIds.includes(c.id)) op.selected = true;
    sel.appendChild(op);
  });
}

/* Save plot */
function savePlotCard(){
  const title = document.getElementById('plot-title').value.trim();
  const content = document.getElementById('plot-content').value.trim();
  const stage = document.getElementById('plot-stage').value;
  const charIds = Array.from(document.getElementById('plot-chars').selectedOptions).map(o=>o.value);
  if(!title){ alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  if(editingPlotId){
    for(const s of Object.keys(plotData)){
      const idx = plotData[s].findIndex(c=>c.id===editingPlotId);
      if(idx!==-1){
        if(s !== stage){
          const card = plotData[s].splice(idx,1)[0];
          card.title = title; card.content = content; card.stage = stage; card.charIds = charIds;
          plotData[stage].push(card);
        } else {
          plotData[s][idx].title = title;
          plotData[s][idx].content = content;
          plotData[s][idx].charIds = charIds;
        }
        break;
      }
    }
  } else {
    const id = Date.now().toString();
    plotData[stage].push({ id, title, content, stage, charIds });
  }

  closePlotModal();
  renderPlotBoard();
  saveAll();
}

/* Delete plot */
function deletePlotCard(id, stage){
  if(!confirm('í”Œë¡¯ ì¹´ë“œë¥¼ ì‚­ì œí•˜ê² ìŠµë‹ˆê¹Œ?')) return;
  plotData[stage] = plotData[stage].filter(c=>c.id!==id);
  renderPlotBoard(); saveAll();
}

/* âœ¨ í”Œë¡¯ ì´ˆê¸°í™” ê¸°ëŠ¥ ì¶”ê°€ */
function resetPlotBoard(){
    if(!confirm('ê²½ê³ : í”Œë¡¯ ë³´ë“œì˜ ëª¨ë“  ì¹´ë“œë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
    
    // plotDataë¥¼ ì™„ì „íˆ ì´ˆê¸°í™”
    plotData = { 'ê¸°': [], 'ìŠ¹': [], 'ì „': [], 'ê²°': [] };
    
    // í™”ë©´ ë° ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê°±ì‹ 
    renderPlotBoard();
    saveAll();
    alert('í”Œë¡¯ ë³´ë“œì˜ ëª¨ë“  ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
}


/* Render board */
function renderPlotBoard(){
  for(const col of document.querySelectorAll('.column')){
    const stage = col.dataset.stage;
    const container = col.querySelector('.cards');
    container.innerHTML = '';
    const list = plotData[stage] || [];
    list.forEach(card=>{
      const el = document.createElement('div');
      el.className = 'plot-card';
      el.draggable = true;
      el.dataset.id = card.id;
      el.dataset.stage = stage;
      el.ondragstart = onDragStart;
      el.ondragend = onDragEnd;
      // âœ¨ìˆ˜ì •: card-actionsì— no-print í´ë˜ìŠ¤ ì œê±°
      el.innerHTML = `
        <div class="card-actions">
          <button class="icon-btn" title="í¸ì§‘" onclick="event.stopPropagation(); openPlotModal('${card.id}', '${stage}')"><span class="material-icons" style="font-size:18px">edit</span></button>
          <button class="icon-btn danger delete-plot-btn" title="ì‚­ì œ" onclick="event.stopPropagation(); deletePlotCard('${card.id}','${stage}')"><span class="material-icons" style="font-size:18px">close</span></button>
        </div>
        <div class="title">${escapeHtml(card.title)}</div>
        <div class="content">${escapeHtml(card.content)}</div>
        <div class="tags">${(card.charIds||[]).map(cid=>{ const ch = characterData.find(x=>x.id===cid); return ch ? `<span class="tag">${escapeHtml(ch.name)}</span>` : '' }).join('')}</div>
      `;
      container.appendChild(el);
    });
    const counter = col.querySelector('.count');
    if(counter) counter.textContent = list.length;
  }
}

/* Drag & Drop */
let draggingEl = null;
function onDragStart(e){
  draggingEl = e.target;
  e.dataTransfer.setData('text/plain', e.target.dataset.id);
  e.dataTransfer.effectAllowed = 'move';
  setTimeout(()=> e.target.classList.add('dragging'), 10);
}
function onDragEnd(){
  if(draggingEl) draggingEl.classList.remove('dragging');
  draggingEl = null;
}
// ë“œë˜ê·¸ í—ˆìš© (column ìì²´ì— ì´ë²¤íŠ¸ë¥¼ ê±¸ì–´ ë¹ˆ ê³µê°„ì—ë„ ë“œë¡­ì´ ê°€ëŠ¥í•˜ë„ë¡ ì²˜ë¦¬)
function allowDrop(e){ e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }

function onDrop(e, newStage){
  e.preventDefault();
  const id = e.dataTransfer.getData('text/plain');
  if(!id) return;
  let moved = null;
  for(const s of Object.keys(plotData)){
    const idx = plotData[s].findIndex(c=>c.id===id);
    if(idx!==-1){
      moved = plotData[s].splice(idx,1)[0];
      break;
    }
  }
  if(!moved) return;
  moved.stage = newStage;
  plotData[newStage].push(moved);
  renderPlotBoard(); saveAll();
}

/* Export board as PNG (uses html2canvas) */
async function exportBoardAsPNG(){
  const board = document.getElementById('plot-board');
  const allColumns = document.querySelectorAll('.column'); 
  // ìº¡ì²˜ ì‹œ ìˆ¨ê²¨ì•¼ í•  ìš”ì†Œë“¤(ëª¨ë“  ë²„íŠ¼ê³¼ ì•„ì´ì½˜)ì„ ì°¾ìŠµë‹ˆë‹¤.
  const noPrintEls = board.querySelectorAll('.card-actions, .add-card-btn, .btn.danger, .btn.ghost');
  const exportBtn = document.querySelector('.btn.ghost'); 
  
  // 1. ë²„íŠ¼ ë¹„í™œì„±í™” ë° í…ìŠ¤íŠ¸ ë³€ê²½
  exportBtn.disabled = true;
  exportBtn.textContent = 'ì €ì¥ ì¤‘...';
  
  // 2. ìº¡ì²˜ ì‹œ ìˆ¨ê¸¸ ìš”ì†Œ ìˆ¨ê¸°ê¸° (CSSì˜ .no-print ì—­í• ì„ ì¼ì‹œì ìœ¼ë¡œ JSì—ì„œ ì²˜ë¦¬)
  noPrintEls.forEach(el => el.style.visibility = 'hidden');
  
  // 3. ëª¨ë“  ì»¬ëŸ¼ì˜ ë†’ì´ ì œí•œ í•´ì œ
  allColumns.forEach(col => col.classList.add('capture-full-height')); 

  // 4. ë³´ë“œì— í™•ì¥ í´ë˜ìŠ¤ ì ìš©
  board.classList.add('capture-expand');

  // DOM ë³€ê²½ í›„ ì ì‹œ ëŒ€ê¸°í•˜ì—¬ ë¸Œë¼ìš°ì €ê°€ ë ˆì´ì•„ì›ƒì„ ë‹¤ì‹œ ê³„ì‚°í•˜ë„ë¡ ê°•ì œ (ì˜ë¦¼ í˜„ìƒ ë°©ì§€)
  await new Promise(resolve => setTimeout(resolve, 50)); 

  // 5. ìº¡ì²˜í•  ë„ˆë¹„/ë†’ì´ë¥¼ í´ë˜ìŠ¤ ì ìš© í›„ scrollWidth/ScrollHeightë¡œ ê³„ì‚°
  const captureWidth = board.scrollWidth;
  const captureHeight = board.scrollHeight;

  try {
    const canvas = await html2canvas(board, {
      scale: 2,
      useCORS: true,
      logging: false,
      width: captureWidth, 
      height: captureHeight,
      windowWidth: captureWidth,
      windowHeight: captureHeight
    });
    
    const dataUrl = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = `plot-board_${new Date().toISOString().slice(0,10)}.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    alert('PNG íŒŒì¼ ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch(err){
    console.error('ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨', err);
    alert('PNG ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ë³´ì•ˆ/ë¦¬ì†ŒìŠ¤ ì œí•œ ê°€ëŠ¥ì„±)');
  } finally {
    // 6. í´ë˜ìŠ¤ ë° ìˆ¨ê¸´ ìš”ì†Œ ë³µêµ¬ ë° ë²„íŠ¼ ì¬í™œì„±í™”
    board.classList.remove('capture-expand');
    allColumns.forEach(col => col.classList.remove('capture-full-height')); 
    
    // âœ¨ ìˆ˜ì •: ìº¡ì²˜ ì „ì— JSë¡œ ìˆ¨ê²¼ë˜ ëª¨ë“  ìš”ì†Œë¥¼ ë‹¤ì‹œ ë³´ì´ë„ë¡ visibility ì†ì„± ì œê±°
    noPrintEls.forEach(el => el.style.removeProperty('visibility')); 

    exportBtn.disabled = false;
    exportBtn.textContent = 'ë³´ë“œ ì „ì²´ PNG ì €ì¥';
  }
}

/* Helpers */
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* Expose for console testing */
window._np = { characterData, plotData, saveAll, loadData, renderPlotBoard, renderCharacterList };

</script>
</body>
</html>
